<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è Telegram Web App */
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .process-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-color: var(--tg-theme-hint-color, #999999);
        }

        /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
        .container {
            padding-top: 0;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="loginScreen" class="screen active">
            <div class="container">
                <div class="header">
                    <h1>‚è±Ô∏è –•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂</h1>
                    <p>Telegram Web App</p>
                </div>

                <div class="login-form">
                    <input type="text" id="userNameInput" placeholder="–í–∞—à–µ –∏–º—è" class="input">
                    <button onclick="login()" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ -->
        <div id="processScreen" class="screen">
            <div class="container">
                <div class="header">
                    <h1>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å</h1>
                    <p id="userGreeting"></p>
                </div>

                <div id="processList" class="process-list"></div>

                <div class="actions">
                    <button onclick="showHistory()" class="btn btn-secondary">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
                    <button onclick="logout()" class="btn btn-secondary">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ -->
        <div id="activeScreen" class="screen">
            <div class="container">
                <div class="header">
                    <h1 id="activeProcessName"></h1>
                    <p id="activeTimer" class="timer">00:00:00</p>
                </div>

                <div id="stepsContainer" class="steps-container"></div>

                <div class="actions">
                    <button onclick="stopProcess()" class="btn btn-danger">‚èπ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    <button onclick="cancelProcess()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
        <div id="completeScreen" class="screen">
            <div class="container">
                <div class="header">
                    <h1>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</h1>
                </div>

                <textarea id="commentInput" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="textarea"></textarea>

                <div class="photo-section">
                    <label for="photoInput" class="btn btn-secondary">
                        üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    </label>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
                    <div id="photoPreview"></div>
                </div>

                <div class="actions">
                    <button onclick="saveRecord()" class="btn btn-primary">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="cancelComplete()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∏—Å—Ç–æ—Ä–∏–∏ -->
        <div id="historyScreen" class="screen">
            <div class="container">
                <div class="header">
                    <h1>üìä –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç</h1>
                </div>

                <div id="historyList" class="history-list"></div>

                <div class="actions">
                    <button onclick="showProcessList()" class="btn btn-primary">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;

        // –†–∞—Å—à–∏—Ä—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.expand();

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.onClick(() => {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen.id === 'processScreen') {
                tg.close();
            } else if (activeScreen.id === 'activeScreen') {
                cancelProcess();
            } else if (activeScreen.id === 'completeScreen') {
                cancelComplete();
            } else if (activeScreen.id === 'historyScreen') {
                showProcessList();
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö –∫—Ä–æ–º–µ –ª–æ–≥–∏–Ω–∞
        function updateBackButton() {
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen.id === 'loginScreen') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
            }
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–º–µ–Ω—ã —ç–∫—Ä–∞–Ω–∞
        const originalShowScreen = window.showScreen;
        window.showScreen = function(screenId) {
            originalShowScreen(screenId);
            updateBackButton();
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–≤–µ—Å—Ç–µ–Ω Telegram
        window.addEventListener('load', () => {
            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser) {
                const userName = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
                document.getElementById('userNameInput').value = userName;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π userId
                const savedUserId = localStorage.getItem('userId');
                if (savedUserId) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
                    login();
                }
            }

            updateBackButton();
        });

        // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        tg.ready();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        function sendDataToBot(data) {
            tg.sendData(JSON.stringify(data));
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram
        const originalShowNotification = window.showNotification;
        window.showNotification = function(message, type = 'info') {
            if (type === 'success') {
                tg.showAlert(message);
            } else if (type === 'error') {
                tg.showAlert('‚ùå ' + message);
            } else {
                originalShowNotification(message, type);
            }
        };

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram UI
        const originalConfirm = window.confirm;
        window.confirm = function(message) {
            return new Promise((resolve) => {
                tg.showConfirm(message, (confirmed) => {
                    resolve(confirmed);
                });
            });
        };

        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö
        function vibrate(style = 'medium') {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred(style);
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –∫ –∫–Ω–æ–ø–∫–∞–º
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => vibrate('light'));
            });
        });
    </script>
</body>
</html>
